name: Release Merge

on:
  pull_request_review:
    types: [submitted]
  push:
    branches:
      - 'release/*'

jobs:
  merge-and-tag:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Check version consistency
      run: |
        # Extract the version from foo/__init__.py
        VERSION=$(grep __version__ foo/__init__.py | cut -d'"' -f2)

        # Extract the version from the branch name
        BRANCH_VERSION=$(echo "${{ github.ref }}" | cut -d'/' -f2)

        # Compare the versions
        if [ "$VERSION" != "$BRANCH_VERSION" ]; then
          echo "Error: version mismatch between foo/__init__.py and branch name"
          exit 1
        fi

    - name: Merge
      if: steps.check_tag.outcome == 'success' && github.event.review.state == 'approved'
      run: |
        git fetch --all
        git checkout ${{ github.event.push.ref }}
        git merge origin/main
        git push

    - name: Tag
      if: steps.check_tag.outcome == 'success' && github.event.review.state == 'approved'
      run: |
        tag=$(echo "${{ github.event.push.ref }}" | sed 's/release\///')
        git tag -a "${tag}" -m "Release ${tag}"
        git push origin "${tag}"